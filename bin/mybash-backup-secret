#!/bin/bash

RCLONE_FLAGS="--progress" #"--dry-run"

function mybash-backup-secret {
    if ! command -v rclone >/dev/null 2>&1; then
        return
    fi
    local prefix
    prefix="${1:-mybash}"

    local sources
    sources=(
        "${HOME}/gpg"
        "${HOME}/OpenVPN/config"
        "${HOME}/.gnupg"
        "${HOME}/.password-store"
        "${HOME}/.ssh"
        "${HOME}/.config"
        "${HOME}/.aws"
        "${HOME}/.azure"
        "${HOME}/AppData/Roaming/gcloud"
        "${HOME}/AppData/Roaming/terraform.rc"
    )
    local primary
    primary="dropbox"
    local secondary
    secondary="gdrive"

    local source
    for source in "${sources[@]}"; do
        local destination
        destination="${prefix}/${source#${HOME}/}"
        if [[ -d "${source}" ]]; then
            rclone ${RCLONE_FLAGS} mkdir "${primary}:${destination}"
            rclone ${RCLONE_FLAGS} mkdir "${secondary}:${destination}"
            rclone ${RCLONE_FLAGS} sync --exclude ".tmp*/**" "${source}" "${primary}:${destination}"
            rclone ${RCLONE_FLAGS} sync --exclude ".tmp*/**" "${primary}:${destination}" "${secondary}:${destination}"
        elif [[ -e "${source}" ]]; then
            rclone ${RCLONE_FLAGS} copy "${source}" "${primary}:${destination}"
            rclone ${RCLONE_FLAGS} copy "${primary}:${destination}" "${secondary}:${destination}"
        else
            echo "skip ${source}"
        fi
    done
}

if [[ "mybash-backup-secret" = "$(basename "${BASH_SOURCE[0]}")" ]]; then
    time mybash-backup-secret "$@"
fi
